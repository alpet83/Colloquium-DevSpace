# Change Log

## Recent Changes (2025-07-20)
### File Preview
- Added support for viewing file contents in the frontend by clicking @attach#<file_id> or @attached_file#<file_id> in ChatContainer.vue.
- Implemented GET /chat/file_contents in file_routes.py to retrieve file content via FileManager.get_file(file_id)['content'].
- Added <dialog ref="filePreviewModal"> in ChatContainer.vue to display file content in <pre class="file-preview"> with light gray font and vertical scrolling.
- Fixed horizontal scrollbar issue in file preview by setting max-width: 90vw and overflow-x: hidden for .file-preview-modal.
- Removed excessive logging of unresolved @attach#<file_id> in formatMessage, replacing with <span class="file-unavailable">Файл <file_id> удалён или недоступен</span>.

### LLM Statistics
- Fixed token counting in llm_interactor.py by using usage.prompt_tokens instead of usage.tokens, resolving discrepancy (e.g., 4191 vs. 3870 tokens).
- Introduced llm_usage table in llm_interactor.py via DataTable with fields ts, model, sent_tokens, used_tokens, chat_id for persistent LLM usage tracking.
- Updated /chat/get_stats in chat_routes.py to fetch statistics from llm_usage using select_row for consistency, replacing chat_stats dictionary.
- Moved statistics collection from ReplicationManager to LLMInteractor to reduce module overload.

### Recursive Dialogue
- Fixed issue where recursive dialogue stopped after one LLM actor by removing break in _recursive_replicate in replication.py, allowing all LLM actors (e.g., grok3, grok4) to respond to @all.
- Verified via logs: successful dialogue between grok3 and grok4 for chat_id=1 at rql=1 and rql=2.

### Code Optimization
- Removed redundant llm_usage table creation in db.py, as DataTable in llm_interactor.py handles table creation and updates.
- Renamed handle_exception to log_and_raise and moved it to basic_logger.py as a method of BasicLogger for better specificity and integration with logging.
- Updated chat_routes.py, file_routes.py, llm_interactor.py, and replication.py to use log.logger.log_and_raise for consistent exception handling.

### Testing
- **API**:
  - `curl -H "Cookie: session_id=<your_session_id>" "http://vps.vpn:8008/api/chat/get_stats?chat_id=1"`.
  - `curl -H "Cookie: session_id=<your_session_id>" "http://vps.vpn:8008/api/chat/file_contents?file_id=1"`.
- **Database**:
  - `sqlite3 /app/data/multichat.db "SELECT * FROM llm_usage WHERE chat_id=1 ORDER BY ts DESC LIMIT 1"`.
  - `sqlite3 /app/data/multichat.db "SELECT * FROM posts WHERE chat_id=1"`.
- **Unit tests**:
  - `docker exec colloquium-core python -m unittest tests.test_replication -v`.


## Recent Changes (2025-07-25)
### File Processors
- **Enhanced FilePatchProcessor**: Updated to use `code-lines` class for `<mismatch>` tables, ensuring proper HTML escaping of `<td>` content in the frontend (`ChatContainer.vue`). This improves the display of patch mismatch errors with a consistent monospaced font and red borders.
- **New FileUndoProcessor**: Added to process `<undo file_id="..." time_back="..."/>` tags, allowing restoration of files from backups within a specified time window. Backups are stored in `/agent/projects/backups/<relative_path>.<timestamp>` and removed after successful restoration.
- **New FileReplaceProcessor**: Added to process `<replace file_id="..." find="..." to="...">` tags, enabling text replacement in files using regular expressions. Returns success message if no changes are made or updates the file with new content.
- **New FileMoveProcessor**: Added to process `<move_file file_id="..." new_name="..." overwrite="true|false"/>` tags, supporting file renaming or moving within `/app/projects`. Creates backups for link files and validates paths for security.

### Chat Visualization Improvements
- Added CSS styles for `<table class="code-lines">` in `chat.css` to support `<mismatch>` tables generated by `FilePatchProcessor`. Styles include monospaced font, red borders, and theme-aware text colors (#eee for dark, #333 for light).
- Enhanced `formatMessage` in `ChatContainer.vue` to handle `<code_patch>`, `<shell_code>`, `<stdout>`, `<stderr>`, `<mismatch>`, and `<traceback>` tags with attributes (e.g., `file_id="..."`), ensuring proper rendering in `<pre>` blocks with color-coded lines (red for removals, green for additions, gray for unchanged).
- Improved escaping of `<td>` content in `<table class="code-lines">` using `escapeHtml`, ensuring special characters (e.g., `<`, `>`) are displayed correctly.

### Chat Reactivity Improvements
- Introduced `awaited_files` as a dictionary `{ file_id: retries }` in `ChatContainer.vue` to track unknown file IDs from `@attached_file#<file_id>` references. Unresolved IDs trigger up to three `/chat/list_files` requests via `fetchFilesAndNotify` to fetch file metadata.
- Added `checkAwaitedFiles` method to initiate file list requests when new posts contain unknown file IDs, integrated with `startPolling` to run after `fetchHistory`.
- Enhanced `reformatMessages` to update message formatting after file list updates, removing resolved file IDs from `awaited_files` and decrementing retry counts for unresolved IDs.
- Added logging for file list requests and `awaited_files` updates to aid debugging (`Requested file list for awaited_files: ...`, `Updated awaited_files: ...`).
